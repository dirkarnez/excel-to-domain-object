<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <!-- <script>
        (() => {
            //fetch("./examples/ohms-law.xlsx")
            
        })();
    </script> -->

    <script type="module">
        import { default as hyperFormula } from "./hyperformula.2.7.1.esm.min.js";
        debugger;
        /*
    const parser = buildEmptyParserWithCaching(new Config())

    const ast = parser.parse('=1+A5', adr('A1')).ast as PlusOpAst
    expect(ast.type).toBe(AstNodeType.PLUS_OP)
    expect(ast.left.type).toBe(AstNodeType.NUMBER)
    expect(ast.right.type).toBe(AstNodeType.CELL_REFERENCE)



import {Config} from '../../src/Config'
import {SheetMapping} from '../../src/DependencyGraph'
import {buildTranslationPackage} from '../../src/i18n'
import {enGB} from '../../src/i18n/languages'
import {FunctionRegistry} from '../../src/interpreter/FunctionRegistry'
import {ParserWithCaching} from '../../src/parser'

export function buildEmptyParserWithCaching(config: Config, sheetMapping?: SheetMapping): ParserWithCaching {
  sheetMapping = sheetMapping || new SheetMapping(buildTranslationPackage(enGB))
  return new ParserWithCaching(config, new FunctionRegistry(config), sheetMapping.get)
}
        */

    </script>
    <script type="module">
        import { default as ExcelJS } from "./exceljs.1.8.0.esm.min.js";
        import { default as CodeGenerator } from "./code-generator.js";
        const workbook = new ExcelJS.Workbook();
        const excelFile = await workbook.xlsx.load(
                await (
                    await fetch ("./examples/asd.xlsx")
                )
                .arrayBuffer()
            );

        const worksheet = excelFile.getWorksheet('aaa');

        try {

            const lineHeader = 1;
            const lineToLearn = 2;

            // Array(worksheet.getRow(lineToLearn).actualCellCount)
            // .fill(NaN)
            // .map((_, index) => {
            //     worksheet.getRow(lineToLearn).getCell(1).value
            // })

            // if has formula, they are readonly, else setter
            let rowDataForHyperformula = [];
            worksheet.getRow(lineToLearn).eachCell((cell) => {
                const cellData = cell.value.formula ? `=${cell.value.formula}` : cell.value;
                rowDataForHyperformula.push(cellData);
            });

            const getCellText = cell => {
                if (!!cell.value.richText) {
                    return cell.value.richText.reduce((p, c) => p.text.replaceAll('\n', '') + c.text.replaceAll('\n', ''))
                } else {
                    return `${cell.value}`.replaceAll('\n', '')
                }
            }

            let fields = [];
            worksheet
            .getRow(lineHeader)
            .eachCell((headerCurrentCell, i) => {
                const cell = worksheet.getRow(lineToLearn).getCell(i);
                // cell.value.formula ? `=${cell.value.formula}` : cell.value;
                console.log(`${cell.address}, ${i}`);
                if (i == 30) {
                    debugger;
                }
                const field = {
                    name: getCellText(headerCurrentCell),
                    commentForName: cell.address,
                    readonly: !!cell.value && !!cell.value.formula,
                    formula: !!cell.value && !!cell.value.formula ? cell.value.formula : null
                };
                fields.push(field);
            });


            console.log(CodeGenerator(fields));

            // worksheet.getCell("A2").formulaType === Excel.Enums.FormulaType.Master;
            // console.log(worksheet.getCell("A2").formulaType === ExcelJS.FormulaType.Master);
        } catch (e) {
            debugger;
        }

        debugger;
    </script>
</body>
</html>